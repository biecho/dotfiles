# ============================================================================
# Kitty Terminal Configuration
# ============================================================================

# Theme (managed via current-theme.conf symlink at end of file)

# ----------------------------------------------------------------------------
# Font
# ----------------------------------------------------------------------------
font_family JetBrainsMono Nerd Font
font_size 12

# ----------------------------------------------------------------------------
# Cursor
# ----------------------------------------------------------------------------
cursor_shape beam
cursor_blink_interval 0

# ----------------------------------------------------------------------------
# Window & Layout
# ----------------------------------------------------------------------------
hide_window_decorations titlebar-only
window_padding_width 8
# Dim inactive windows (0.0-1.0, lower = more dim)
inactive_text_alpha 0.8

# Layouts: splits for panes, stack for "zoom" current pane fullscreen
enabled_layouts splits,stack

# ----------------------------------------------------------------------------
# Scrollback
# ----------------------------------------------------------------------------
scrollback_lines 50000

# Scrollback pager - view/search with nvim via kitty-scrollback.nvim (cmd+shift+h)
# Properly renders ANSI codes and provides full nvim features (flash.nvim, etc.)
action_alias kitty_scrollback_nvim kitten ~/.local/share/nvim/lazy/kitty-scrollback.nvim/python/kitty_scrollback_nvim.py
map cmd+shift+h kitty_scrollback_nvim
# Show only the last command's output (great for copying results)
map cmd+shift+g kitty_scrollback_nvim --config ksb_builtin_last_cmd_output

# Jump between shell prompts in scrollback (requires shell integration)
map cmd+shift+p scroll_to_prompt -1
map cmd+shift+n scroll_to_prompt 1

# ----------------------------------------------------------------------------
# Shell Integration & Clipboard
# ----------------------------------------------------------------------------
shell_integration enabled
copy_on_select clipboard

# Allow OSC 52 clipboard reads without confirmation (for nvim paste over SSH)
clipboard_control write-clipboard write-primary read-clipboard read-primary

# Disable paste confirmation prompts
paste_actions quote-urls-at-prompt

# ----------------------------------------------------------------------------
# Remote Control (enables smart-splits.nvim integration)
# ----------------------------------------------------------------------------
# Required for seamless nvim/kitty navigation with smart-splits.nvim
# Kittens installed by: ./kitty/install-kittens.bash (run by lazy.nvim build)
allow_remote_control socket-only
listen_on unix:/tmp/kitty

# ----------------------------------------------------------------------------
# macOS Specific
# ----------------------------------------------------------------------------
macos_option_as_alt yes
macos_quit_when_last_window_closed yes

# ----------------------------------------------------------------------------
# Tab Bar (custom tab_bar.py)
# ----------------------------------------------------------------------------
tab_bar_edge bottom
tab_bar_style custom
tab_bar_min_tabs 1
# Features: process name, SSH indicator (cyan), zoom indicator [Z]

# ----------------------------------------------------------------------------
# Keybindings: Splits
# ----------------------------------------------------------------------------
# Create splits (follows current dir/server with SSH)
map cmd+\ launch --location=vsplit --cwd=current
map cmd+- launch --location=hsplit --cwd=current

# Local splits (always on local machine, useful when SSH'd)
map cmd+shift+\ launch --location=vsplit
map cmd+shift+- launch --location=hsplit

# Close window
map cmd+w close_window

# ----------------------------------------------------------------------------
# Keybindings: Window Navigation (smart-splits.nvim integration)
# ----------------------------------------------------------------------------
# ctrl+hjkl: seamless navigation between nvim and kitty splits
# When nvim is focused, keys pass through to nvim; otherwise kitty handles them
map ctrl+h neighboring_window left
map ctrl+j neighboring_window down
map ctrl+k neighboring_window up
map ctrl+l neighboring_window right

# Pass keys to nvim when it's focused (smart-splits handles navigation)
map --when-focus-on var:IS_NVIM ctrl+h
map --when-focus-on var:IS_NVIM ctrl+j
map --when-focus-on var:IS_NVIM ctrl+k
map --when-focus-on var:IS_NVIM ctrl+l

# ctrl+alt+hjkl: resize splits (works in both nvim and kitty)
# NOTE: alt+hjkl is reserved for AeroSpace window management
map ctrl+alt+h kitten relative_resize.py left 3
map ctrl+alt+j kitten relative_resize.py down 3
map ctrl+alt+k kitten relative_resize.py up 3
map ctrl+alt+l kitten relative_resize.py right 3

map --when-focus-on var:IS_NVIM ctrl+alt+h
map --when-focus-on var:IS_NVIM ctrl+alt+j
map --when-focus-on var:IS_NVIM ctrl+alt+k
map --when-focus-on var:IS_NVIM ctrl+alt+l

# ----------------------------------------------------------------------------
# Keybindings: Window Management
# ----------------------------------------------------------------------------
# Zoom current window (toggle between splits and stack layout)
map cmd+z toggle_layout stack

# Swap window position with another (visual selection)
map cmd+shift+s swap_with_window

# Resize window (enter resize mode, use hjkl to resize)
map cmd+r start_resizing_window

# Detach window: move current pane to new tab or OS window
map cmd+d detach_window new-tab
map cmd+shift+d detach_window

# ----------------------------------------------------------------------------
# Keybindings: Tabs
# ----------------------------------------------------------------------------
# New tab (follows current dir/server)
map cmd+t new_tab_with_cwd

# New local tab (always on local machine)
map cmd+shift+t new_tab

# Tab navigation
map cmd+shift+] next_tab
map cmd+shift+[ previous_tab
map cmd+1 goto_tab 1
map cmd+2 goto_tab 2
map cmd+3 goto_tab 3
map cmd+4 goto_tab 4
map cmd+5 goto_tab 5
map cmd+6 goto_tab 6
map cmd+7 goto_tab 7
map cmd+8 goto_tab 8
map cmd+9 goto_tab 9

# Fuzzy tab picker (fzf)
map cmd+p launch --type=overlay ~/dotfiles/kitty/tab-picker.sh

# ----------------------------------------------------------------------------
# Keybindings: Misc
# ----------------------------------------------------------------------------
# Font size (Ctrl only - Cmd+- is used for hsplit)
map ctrl+equal change_font_size all +1.0
map ctrl+minus change_font_size all -1.0
map ctrl+0 change_font_size all 0
# Disable macOS default Cmd font shortcuts to avoid conflict with splits
map cmd+equal no_op
map cmd+0 no_op

# Clear screen (cmd+l instead of default cmd+k)
map cmd+l clear_terminal to_cursor active
map cmd+k no_op

# Reload config
map cmd+shift+comma load_config_file

# Theme picker (like nvim's <leader>uC) - reloads config so all windows update
map cmd+shift+u launch --type=overlay ~/dotfiles/kitty/theme-picker.sh

# Fullscreen
map cmd+shift+enter toggle_fullscreen

# ----------------------------------------------------------------------------
# Keybindings: Choose Files (fuzzy file picker with previews)
# ----------------------------------------------------------------------------
# Config: ~/dotfiles/kitty/choose-files.conf
# Docs: https://sw.kovidgoyal.net/kitty/kittens/choose-files/
#
# Navigation: Tab=enter dir, Shift+Tab=parent, Ctrl+~=home, Ctrl+/=root
# Multi-select: Shift+Enter to add, Enter to confirm

# Insert file path at cursor (like a file dialog)
map cmd+o kitten choose-files --mode=file

# Insert directory path at cursor
map cmd+shift+o kitten choose-files --mode=dir

# Open file(s) in nvim (Shift+Enter for multi-select, then Enter)
map cmd+e launch --type=overlay sh -c 'files=$(kitten choose-files --mode=files) && [ -n "$files" ] && nvim $files'

# Open directory in nvim (oil.nvim / netrw)
map cmd+shift+e launch --type=overlay sh -c 'dir=$(kitten choose-files --mode=dir) && [ -n "$dir" ] && nvim "$dir"'

# ----------------------------------------------------------------------------
# Keybindings: Hints (select text from terminal output)
# ----------------------------------------------------------------------------
# These are Kitty's built-in hints shortcuts (no custom mappings needed):
#   ctrl+shift+p > f    Insert path from output
#   ctrl+shift+p > n    Open file:line in editor (for grep results, stack traces)
#   ctrl+shift+p > w    Insert word from output
#   ctrl+shift+p > l    Insert line from output
#   ctrl+shift+p > h    Insert hash from output
#
# Note: Avoid mapping ctrl+g - it's used by Claude CLI to edit prompt in $EDITOR


# BEGIN_KITTY_THEME
# Tokyo Night Moon
include current-theme.conf
# END_KITTY_THEME
